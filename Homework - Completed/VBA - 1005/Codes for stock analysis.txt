Public ticker_symbol As String
Public yearly_change_num As Double
Public yearly_change_prct As Double

Sub main()

For sheet_num = 1 To Sheets.Count

    Sheets(sheet_num).Activate
    Call format_agg_table(True)
    Call main_iterator
    Call format_agg_table(False)
    
Next sheet_num

End Sub

Function format_agg_table(beginning)
    If beginning = True Then
        Cells(1, 9) = "Ticker"
        Cells(1, 10) = "Yearly Change"
        Cells(1, 11) = "Percent Change"
        Cells(1, 12) = "Total Stock Volume"
    Else
        'color the cells based on a condition
        Call color_cells
        Call change_to_prct
    End If

End Function

Function change_to_prct()
    Columns("K:K").Select
    Selection.NumberFormat = "0.00%"
End Function

Function color_cells()
    For i = 2 To Cells(Rows.Count, 9).End(xlUp).Row
        If Cells(i, 10) > 0 Then
            Cells(i, 10).Select
            With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = 5296274
                .TintAndShade = 0
                .PatternTintAndShade = 0
            End With
        
        Else
            
            Cells(i, 10).Select
            With Selection.Interior
                .Pattern = xlSolid
                .PatternColorIndex = xlAutomatic
                .Color = 255
                .TintAndShade = 0
                .PatternTintAndShade = 0
            End With
        
        End If
    
    Next i
End Function

Function main_iterator()
Dim start_row As Double 'starting row of the ticker
Dim end_row As Double 'ending row of the ticker
Dim stock_volume As Double
stock_volume = 0
start_row = 2 'first iteration

For i = 2 To Cells(Rows.Count, 1).End(xlUp).Row
    end_row_flag = check_if_next_ticket(i)
    stock_volume = stock_volume + Cells(i, 7)
    If end_row_flag = True Then
        end_row = i
        Call get_agg_info(start_row, end_row, i)
        Call insert_agg_info(ticker_symbol, yearly_change_num, yearly_change_prct, stock_volume)
        stock_volume = 0
        start_row = i + 1
    End If
    
Next i
End Function

Function get_agg_info(start_row, end_row, current_row)
    ticker_symbol = Cells(current_row, 1)
    yearly_change_prct = get_yearly_change_prct(start_row, end_row)
    yearly_change_num = get_yearly_change_num(start_row, end_row)
End Function

Function insert_agg_info(symbol, change_num, change_year, volume)
row_insert = Cells(Rows.Count, 9).End(xlUp).Row + 1
Cells(row_insert, 9) = symbol
Cells(row_insert, 10) = change_num
Cells(row_insert, 11) = change_year
Cells(row_insert, 12) = volume
End Function

Function get_yearly_change_prct(start_row, end_row)
    If Cells(start_row, 3) = 0 Then
        get_yearly_change_prct = 0
    Else
        get_yearly_change_prct = (Cells(end_row, 6) - Cells(start_row, 3)) / Cells(start_row, 3)
    End If
End Function

Function get_yearly_change_num(start_row, end_row)
    get_yearly_change_num = Cells(end_row, 6) - Cells(start_row, 3)
End Function

Function check_if_next_ticket(trow)
    If Cells(trow + 1, 1) <> Cells(trow, 1) Then
        check_if_next_ticket = True
    Else
        check_if_next_ticket = False
    End If
End Function
